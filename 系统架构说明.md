# 智能知识库系统架构说明

## 系统概述

本系统是一个基于RAG（检索增强生成）的智能知识库管理系统，集成了PyMuPDF Pro、PyMuPDF4LLM、LangChain和极客智坊API，实现文档智能处理和智能问答功能。

## 核心架构

```
用户上传文档 → PyMuPDF Pro + PyMuPDF4LLM → LangChain分块 → Embedding → ES存储
                                                                    ↓
用户提问 → RAG检索 → 极客智坊API → 智能对话
```

## 技术栈详解

### 1. 文档处理层

#### PyMuPDF Pro
- **功能**: 统一文档处理引擎
- **支持格式**: PDF、Word、Excel、PowerPoint、TXT等
- **优势**: 
  - 高性能文档解析
  - 多格式统一处理
  - 结构化信息提取

#### PyMuPDF4LLM
- **功能**: 基于LlamaIndex的文档结构化处理
- **作用**: 
  - 将PDF转换为Markdown格式
  - 保持文档的语义结构
  - 智能识别标题层级

### 2. 分块处理层

#### LangChain
- **功能**: 文本分块和向量化
- **分块策略**:
  - 结构化分块：基于Markdown标题层级
  - 语义分块：保持语义完整性
  - 重叠策略：30%重叠确保上下文连贯

#### 分块配置
```python
DOCUMENT_CONFIG = {
    "chunk_size": 1000,        # 块大小
    "chunk_overlap": 300,      # 重叠大小
    "dynamic_overlap": {        # 动态重叠策略
        "pdf": 0.35,           # PDF文档35%重叠
        "docx": 0.25,          # Word文档25%重叠
        "xlsx": 0.30,          # Excel文档30%重叠
    }
}
```

### 3. 向量化存储层

#### Embedding模型
- **模型**: `sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2`
- **特点**: 
  - 多语言支持
  - 轻量级高效
  - 语义理解能力强

#### Elasticsearch存储
- **索引**: `knowledge_base`
- **功能**: 
  - 向量相似度检索
  - 元数据管理
  - 高可用性

### 4. RAG检索层

#### 检索策略
- **Top-K检索**: 检索最相关的5个文档
- **相似度计算**: 余弦相似度
- **上下文构建**: 动态组合相关文档

### 5. LLM对话层

#### 极客智坊API
- **模型**: GPT-4o-mini
- **功能**: 
  - 基于检索结果的智能问答
  - 上下文理解和生成
  - 多轮对话支持

## 核心流程

### 文档上传处理流程

1. **文件接收**: 接收用户上传的文档文件
2. **格式验证**: 检查文件格式是否支持
3. **PyMuPDF Pro处理**: 使用PyMuPDF Pro提取文本
4. **PyMuPDF4LLM结构化**: 转换为Markdown格式
5. **LangChain分块**: 使用MarkdownHeaderTextSplitter进行结构化分块
6. **元数据添加**: 为每个chunk添加知识库元数据
7. **向量化**: 使用Embedding模型生成向量
8. **ES存储**: 将向量和元数据存入Elasticsearch

### 智能问答流程

1. **问题接收**: 接收用户问题
2. **向量化**: 将问题转换为向量
3. **相似度检索**: 在ES中检索最相关的文档
4. **上下文构建**: 组合检索到的文档内容
5. **提示词构建**: 构建包含上下文的提示词
6. **极客智坊API调用**: 调用GPT-4o-mini生成回答
7. **结果返回**: 返回答案和知识引用

## 配置说明

### 主要配置文件

#### `python_service/config.py`
```python
# 文档处理配置
DOCUMENT_CONFIG = {
    "chunk_size": 1000,
    "chunk_overlap": 300,
    "dynamic_overlap": {...}
}

# PyMuPDF Pro配置
PYMUPDF_PRO_CONFIG = {
    "enabled": True,
    "trial_key": "...",
    "supported_formats": {...}
}

# 极客智坊API配置
GEEKAI_API_KEY = "sk-..."
GEEKAI_CHAT_URL = "https://geekai.co/api/v1/chat/completions"
```

## 性能优化

### 1. 文档处理优化
- **并行处理**: 支持多文档并行处理
- **内存管理**: 使用临时文件处理大文档
- **缓存机制**: 缓存Embedding模型

### 2. 检索优化
- **索引优化**: ES索引配置优化
- **查询优化**: 相似度检索算法优化
- **结果缓存**: 缓存常用查询结果

### 3. API调用优化
- **超时设置**: 30秒超时保护
- **重试机制**: API调用失败自动重试
- **回退策略**: API失败时使用模拟回答

## 部署架构

### 服务组件
1. **Python服务**: `app_pymupdf_pro.py` (端口8000)
2. **Java后端**: Spring Boot应用 (端口8080)
3. **Elasticsearch**: 搜索引擎 (端口9200)
4. **前端界面**: Web界面 (端口3000)

### 启动顺序
1. 启动Elasticsearch
2. 启动Java后端服务
3. 启动Python服务
4. 启动前端界面

## 监控和日志

### 健康检查
- **ES连接检查**: 验证Elasticsearch连接
- **PyMuPDF Pro检查**: 验证文档处理能力
- **API可用性检查**: 验证极客智坊API连接

### 日志记录
- **处理日志**: 记录文档处理过程
- **API日志**: 记录极客智坊API调用
- **错误日志**: 记录异常和错误信息

## 扩展性

### 1. 新文档格式支持
- 在PyMuPDF Pro配置中添加新格式
- 在文档处理函数中添加解析逻辑

### 2. 新LLM集成
- 在配置中添加新的API配置
- 在对话函数中添加新的API调用

### 3. 新检索策略
- 在检索函数中添加新的检索算法
- 支持混合检索策略

## 总结

本系统实现了完整的RAG架构：
- **文档处理**: PyMuPDF Pro + PyMuPDF4LLM
- **分块策略**: LangChain结构化分块
- **向量存储**: Elasticsearch
- **智能问答**: 极客智坊API + GPT-4o-mini

通过这种架构，系统能够：
1. 智能处理多种文档格式
2. 保持文档的语义结构
3. 提供准确的相似度检索
4. 生成高质量的智能回答
