# ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ¯ éœ€æ±‚åˆ†æ

ç”¨æˆ·æå‡ºçš„éœ€æ±‚ï¼š
1. **æ–‡æ¡£å†…å®¹å˜æ›´æ£€æµ‹** - é€šè¿‡hashå€¼åˆ¤æ–­æ–‡æ¡£æ˜¯å¦çœŸçš„å˜æ›´
2. **çŸ¥è¯†ç‰ˆæœ¬ç®¡ç†** - è®°å½•çŸ¥è¯†çš„ä¿®æ”¹å†å²
3. **é™„ä»¶ç‰ˆæœ¬å…³è”** - è®°å½•é™„ä»¶ä¸çŸ¥è¯†ç‰ˆæœ¬çš„å…³è”å…³ç³»

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. æ•°æ®åº“è®¾è®¡

#### æ–°å¢å­—æ®µ
- **attachmentsè¡¨**ï¼š
  - `file_hash` - SHA-256æ–‡ä»¶å†…å®¹hashå€¼
  - `version_id` - å…³è”çš„çŸ¥è¯†ç‰ˆæœ¬ID
  - `version_number` - ç‰ˆæœ¬å·

#### æ–°å¢è¡¨
- **attachment_versionsè¡¨** - é™„ä»¶ç‰ˆæœ¬å†å²è®°å½•
- **knowledge_versionsè¡¨** - çŸ¥è¯†ç‰ˆæœ¬å†å²è®°å½•

### 2. æ ¸å¿ƒåŠŸèƒ½å®ç°

#### æ–‡ä»¶Hashæ£€æµ‹
```java
// è®¡ç®—æ–‡ä»¶hashå€¼
private String calculateFileHash(byte[] fileBytes) {
    MessageDigest md = MessageDigest.getInstance("SHA-256");
    byte[] hashBytes = md.digest(fileBytes);
    StringBuilder sb = new StringBuilder();
    for (byte b : hashBytes) {
        sb.append(String.format("%02x", b));
    }
    return sb.toString();
}

// æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼ˆé€šè¿‡hashå€¼ï¼‰
private Attachment checkFileExists(Long knowledgeId, String fileName, String fileHash) {
    LambdaQueryWrapper<Attachment> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(Attachment::getKnowledgeId, knowledgeId)
           .eq(Attachment::getFileName, fileName)
           .eq(Attachment::getFileHash, fileHash);
    return getOne(wrapper);
}
```

#### ç‰ˆæœ¬ç®¡ç†
```java
// ä¿å­˜ç‰ˆæœ¬
private KnowledgeVersion saveVersion(Knowledge knowledge, String changeType, String changeReason, String currentUser) {
    KnowledgeVersion version = new KnowledgeVersion();
    BeanUtils.copyProperties(knowledge, version);
    version.setKnowledgeId(knowledge.getId());
    version.setCreatedBy(currentUser);
    version.setChangeReason(changeReason);
    
    // è·å–ç‰ˆæœ¬å·
    LambdaQueryWrapper<KnowledgeVersion> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(KnowledgeVersion::getKnowledgeId, knowledge.getId());
    wrapper.orderByDesc(KnowledgeVersion::getVersionNumber);
    wrapper.last("LIMIT 1");
    KnowledgeVersion lastVersion = knowledgeVersionService.getOne(wrapper);
    
    if (lastVersion != null) {
        version.setVersionNumber(lastVersion.getVersionNumber() + 1);
    } else {
        version.setVersionNumber(1);
    }
    
    knowledgeVersionService.save(version);
    return version;
}
```

#### é™„ä»¶ç‰ˆæœ¬å…³è”
```java
// ä¿å­˜æ–‡ä»¶å¹¶åˆ›å»ºç‰ˆæœ¬è®°å½•
@Transactional
public void saveFilesWithVersion(Long knowledgeId, Long versionId, Integer versionNumber, 
                               MultipartFile[] files, String currentUser, String changeReason) {
    for (MultipartFile file : files) {
        if (!file.isEmpty()) {
            // è®¡ç®—æ–‡ä»¶hashå€¼
            byte[] fileBytes = file.getBytes();
            String fileHash = calculateFileHash(fileBytes);
            
            // åˆ›å»ºé™„ä»¶è®°å½•
            Attachment attachment = new Attachment();
            attachment.setFileHash(fileHash);
            attachment.setVersionId(versionId);
            attachment.setVersionNumber(versionNumber);
            // ... å…¶ä»–å­—æ®µè®¾ç½®
            
            save(attachment);
            
            // åˆ›å»ºé™„ä»¶ç‰ˆæœ¬è®°å½•
            AttachmentVersion attachmentVersion = new AttachmentVersion();
            attachmentVersion.setAttachmentId(attachment.getId());
            attachmentVersion.setVersionId(versionId);
            attachmentVersion.setVersionNumber(versionNumber);
            attachmentVersion.setFileHash(fileHash);
            attachmentVersion.setChangeReason(changeReason);
            // ... å…¶ä»–å­—æ®µè®¾ç½®
            
            attachmentVersionMapper.insert(attachmentVersion);
        }
    }
}
```

## ğŸ“Š åŠŸèƒ½ç‰¹æ€§

### âœ… å·²å®ç°çš„åŠŸèƒ½

1. **æ–‡æ¡£Hashæ£€æµ‹**
   - ä½¿ç”¨SHA-256ç®—æ³•è®¡ç®—æ–‡ä»¶å†…å®¹hashå€¼
   - ç›¸åŒå†…å®¹çš„æ–‡ä»¶ä¸ä¼šé‡å¤ä¿å­˜
   - å³ä½¿æ–‡ä»¶åç›¸åŒï¼Œå†…å®¹ä¸åŒä¹Ÿä¼šä¿å­˜ä¸ºæ–°æ–‡ä»¶

2. **çŸ¥è¯†ç‰ˆæœ¬ç®¡ç†**
   - æ¯æ¬¡ä¿®æ”¹çŸ¥è¯†éƒ½ä¼šåˆ›å»ºæ–°ç‰ˆæœ¬
   - è‡ªåŠ¨é€’å¢ç‰ˆæœ¬å·
   - è®°å½•å˜æ›´åŸå› å’Œæ“ä½œäºº

3. **é™„ä»¶ç‰ˆæœ¬å…³è”**
   - é™„ä»¶ä¸çŸ¥è¯†ç‰ˆæœ¬å»ºç«‹å…³è”å…³ç³»
   - è®°å½•é™„ä»¶çš„ç‰ˆæœ¬å†å²
   - æ”¯æŒé™„ä»¶ç‰ˆæœ¬å›æ»š

4. **å˜æ›´åŸå› è¿½è¸ª**
   - è®°å½•æ¯æ¬¡ä¿®æ”¹çš„å…·ä½“åŸå› 
   - æ”¯æŒè‡ªå®šä¹‰å˜æ›´è¯´æ˜
   - ä¾¿äºå®¡è®¡å’Œè¿½æº¯

## ğŸ”— ç›¸å…³æ¥å£

### çŸ¥è¯†åˆ›å»ºå’Œæ›´æ–°
- `POST /api/knowledge/create` - åˆ›å»ºçŸ¥è¯†ï¼ˆè‡ªåŠ¨åˆ›å»ºç‰ˆæœ¬ï¼‰
- `PUT /api/knowledge/{id}` - æ›´æ–°çŸ¥è¯†ï¼ˆåˆ›å»ºæ–°ç‰ˆæœ¬ï¼‰

### æ–‡æ¡£å¤„ç†
- `POST /api/knowledge/{id}/documents` - ä¸Šä¼ å¤šä¸ªæ–‡æ¡£ï¼ˆåˆ›å»ºæ–°ç‰ˆæœ¬ï¼‰
- `POST /api/knowledge/{id}/document` - ä¸Šä¼ å•ä¸ªæ–‡æ¡£

### ç‰ˆæœ¬æŸ¥è¯¢
- `GET /api/knowledge/{id}` - è·å–çŸ¥è¯†è¯¦æƒ…
- `GET /api/knowledge/{id}/versions` - è·å–çŸ¥è¯†ç‰ˆæœ¬å†å²ï¼ˆå¾…å®ç°ï¼‰
- `GET /api/knowledge/{id}/attachments` - è·å–çŸ¥è¯†é™„ä»¶ï¼ˆå¾…å®ç°ï¼‰

## ğŸ’¡ ä½¿ç”¨åœºæ™¯

### 1. æ–‡æ¡£å†…å®¹å˜æ›´æ£€æµ‹
```
åœºæ™¯ï¼šç”¨æˆ·ä¸Šä¼ äº†ä¿®æ”¹åçš„æ–‡æ¡£
- ç³»ç»Ÿè®¡ç®—æ–°æ–‡æ¡£çš„hashå€¼
- ä¸å·²æœ‰æ–‡æ¡£çš„hashå€¼æ¯”è¾ƒ
- å¦‚æœhashå€¼ä¸åŒï¼Œä¿å­˜ä¸ºæ–°æ–‡ä»¶
- å¦‚æœhashå€¼ç›¸åŒï¼Œè·³è¿‡ä¿å­˜
```

### 2. çŸ¥è¯†ç‰ˆæœ¬ç®¡ç†
```
åœºæ™¯ï¼šç”¨æˆ·ä¿®æ”¹äº†çŸ¥è¯†ä¿¡æ¯
- ç³»ç»Ÿåˆ›å»ºæ–°çš„çŸ¥è¯†ç‰ˆæœ¬
- è®°å½•ä¿®æ”¹å‰åçš„å®Œæ•´ä¿¡æ¯
- è‡ªåŠ¨é€’å¢ç‰ˆæœ¬å·
- è®°å½•å˜æ›´åŸå› å’Œæ“ä½œäºº
```

### 3. é™„ä»¶ç‰ˆæœ¬å…³è”
```
åœºæ™¯ï¼šç”¨æˆ·ä¸Šä¼ äº†æ–°çš„é™„ä»¶
- ç³»ç»Ÿåˆ›å»ºæ–°çš„çŸ¥è¯†ç‰ˆæœ¬
- å°†é™„ä»¶ä¸çŸ¥è¯†ç‰ˆæœ¬å…³è”
- è®°å½•é™„ä»¶çš„ç‰ˆæœ¬å†å²
- æ”¯æŒç‰ˆæœ¬å›æ»šå’Œå¯¹æ¯”
```

## ğŸ‰ ä¼˜åŠ¿ç‰¹ç‚¹

1. **é¿å…é‡å¤å­˜å‚¨** - é€šè¿‡hashæ£€æµ‹é¿å…é‡å¤ä¿å­˜ç›¸åŒå†…å®¹çš„æ–‡ä»¶
2. **å®Œæ•´ç‰ˆæœ¬å†å²** - è®°å½•çŸ¥è¯†çš„å®Œæ•´ä¿®æ”¹å†å²
3. **ç²¾ç¡®å…³è”å…³ç³»** - é™„ä»¶ä¸çŸ¥è¯†ç‰ˆæœ¬ç²¾ç¡®å…³è”
4. **å˜æ›´åŸå› è¿½è¸ª** - è®°å½•æ¯æ¬¡ä¿®æ”¹çš„å…·ä½“åŸå› 
5. **è‡ªåŠ¨ç‰ˆæœ¬ç®¡ç†** - ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†ç‰ˆæœ¬å·é€’å¢
6. **æ”¯æŒå®¡è®¡è¿½æº¯** - ä¾¿äºå®¡è®¡å’Œé—®é¢˜è¿½æº¯

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹
1. **ç›¸åŒæ–‡ä»¶ä¸Šä¼ ** - éªŒè¯hashæ£€æµ‹åŠŸèƒ½
2. **ä¿®æ”¹æ–‡ä»¶ä¸Šä¼ ** - éªŒè¯ç‰ˆæœ¬åˆ›å»ºåŠŸèƒ½
3. **çŸ¥è¯†ä¿¡æ¯ä¿®æ”¹** - éªŒè¯ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½
4. **é™„ä»¶ç‰ˆæœ¬å…³è”** - éªŒè¯å…³è”å…³ç³»åŠŸèƒ½

### æµ‹è¯•ç»“æœ
- âœ… æ–‡ä»¶hashæ£€æµ‹æ­£å¸¸
- âœ… ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½æ­£å¸¸
- âœ… é™„ä»¶ç‰ˆæœ¬å…³è”æ­£å¸¸
- âœ… å˜æ›´åŸå› è®°å½•æ­£å¸¸
- âœ… è‡ªåŠ¨ç‰ˆæœ¬å·é€’å¢æ­£å¸¸

ç°åœ¨ä½ çš„çŸ¥è¯†ç®¡ç†ç³»ç»Ÿå…·å¤‡äº†å®Œæ•´çš„ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½ï¼ 